define(["jquery","knockout"],function(h,v){return function(u){"use strict";u.kg||(u.kg={}),u.kg.numberOfGrids=0,u.kg.eventStorage={};var e,l="__kg_selected__",s="asc",t="desc",d="_kg_field_",g="_kg_depth_",p="_kg_hidden_",f="_kg_column_",i="_kg_agg_index_",c=/<.+>/;u.kg.moveSelectionHandler=function(e,t){if(u.kg.utils.isNullOrUndefined(e)||u.kg.utils.isNullOrUndefined(e.config.selectedItems))return!0;var n=t.which||t.keyCode,o=38===n?-1:40===n?1:null;if(!o)return!0;var i=e.renderedRows(),r=i.indexOf(e.selectionService.lastClickedRow)+o;return r<0||r>=i.length||(e.selectionService.ChangeSelection(i[r],t),r>i.length-8?e.$viewport.scrollTop(e.$viewport.scrollTop()+8*e.config.rowHeight):r<8&&e.$viewport.scrollTop(e.$viewport.scrollTop()-8*e.config.rowHeight),!1)},String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length>>>0,n=Number(arguments[1])||0;for((n=n<0?Math.ceil(n):Math.floor(n))<0&&(n+=t);n<t;n++)if(n in this&&this[n]===e)return n;return-1}),Array.prototype.filter||(Array.prototype.filter=function(e){var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;for(var o=[],i=arguments[1],r=0;r<n;r++)if(r in t){var a=t[r];e.call(i,a,r,t)&&o.push(a)}return o}),u.kg.utils={visualLength:function(e){var t=document.getElementById("testDataLength");return t||((t=document.createElement("SPAN")).id="testDataLength",t.style.visibility="hidden",document.body.appendChild(t)),h(t).css("font",h(e).css("font")),t.innerHTML=h(e).text(),t.offsetWidth},forIn:function(e,t){for(var n in e)e.hasOwnProperty(n)&&t(e[n],n)},evalProperty:function(e,t){var n=v.utils.unwrapObservable(e),o=t.split("."),i=0,r=v.utils.unwrapObservable(n[o[i]]),a=o.length;for(i++;r&&i<a;)r=v.utils.unwrapObservable(r[o[i]]),i++;return r},endsWith:function(e,t){return!(!e||!t||"string"!=typeof e)&&-1!==e.indexOf(t,e.length-t.length)},isNullOrUndefined:function(e){return null==e},getElementsByClassName:function(e){for(var t=[],n=new RegExp("\\b"+e+"\\b"),o=document.getElementsByTagName("*"),i=0;i<o.length;i++){var r=o[i].className;n.test(r)&&t.push(o[i])}return t},getTemplatePromise:function(e){return h.ajax(e)},newId:(e=(new Date).getTime(),function(){return e+=1}),ieVersion:function(){for(var e=3,t=document.createElement("div"),n=t.getElementsByTagName("i");t.innerHTML="\x3c!--[if gt IE "+ ++e+"]><i></i><![endif]--\x3e",n[0];);return 4<e?e:void 0}()},h.extend(u.kg.utils,{isIe6:6===u.kg.utils.ieVersion,isIe7:7===u.kg.utils.ieVersion,isIe:void 0!==u.kg.utils.ieVersion}),u.kg.aggregateTemplate=function(){return'<div data-bind="click: toggleExpand, style: {\'left\': offsetLeft()}" class="kgAggregate"><span class="kgAggregateText"><span class="kgAggregateLabel" data-bind="html: $data.label"></span> <span class="kgAggregateTotal"><span data-bind="html: totalChildren"></span> <span data-bind="text: totalChildren() > 1 ? \'Items\' : \'Item\'"></span></span></span><div data-bind="attr: {\'class\' : aggClass }"></div></div>'},u.kg.defaultCellTemplate=function(){return"<div data-bind=\"attr: { 'class': 'kgCellText colt' + $index()}, html: $data.getProperty($parent)\"></div>"},u.kg.defaultGridTemplate=function(){return'<div data-bind="css: {\'ui-widget\': jqueryUITheme, \'kgNoSelect\' : disableTextSelection}"><div class="kgTopPanel" data-bind="css: {\'ui-widget-header\':jqueryUITheme, \'ui-corner-top\': jqueryUITheme}, style: $data.topPanelStyle"><div data-bind="if: displayHeaderPager"><div class="kgHeaderPagerPanel" data-bind="template: \'pagerPanelTemplate\', css: {\'ui-widget-content\': jqueryUITheme, \'ui-corner-bottom\': jqueryUITheme}, style: headerPagerStyle"></div></div><div class="kgGroupPanel" data-bind="visible: $data.showGroupPanel, style: headerStyle"><div class="kgGroupPanelDescription" data-bind="visible: configGroups().length == 0">Drag a column header here and drop it to group by that column</div><ul data-bind="visible: configGroups().length > 0, foreach: configGroups" class="kgGroupList"><li class="kgGroupItem"><span class="kgGroupElement"><div class="kgGroupName"><span data-bind="text: displayName"></span> <span data-bind="click: function(data) { $root.removeGroup($index()) }" class="kgRemoveGroup">x</span></div><span data-bind="visible: $index() < ($root.configGroups().length - 1)" class="kgGroupArrow"></span></span></li></ul></div><div class="kgHeaderContainer" data-bind="style: headerStyle"><div class="kgHeaderScroller" data-bind="style: headerScrollerStyle, kgHeaderRow: $data"></div></div><div class="kgHeaderButton" data-bind="visible: ($data.showColumnMenu || $data.showFilter), click: toggleShowMenu"><div class="kgHeaderButtonArrow"></div></div><div data-bind="visible: showMenu" class="kgColMenu"><div data-bind="visible: showFilter"><input placeholder="Search Field:Value" type="text" data-bind="value: filterText, valueUpdate: \'afterkeydown\'"></div><div data-bind="visible: showColumnMenu"><span class="kgMenuText">Choose Columns:</span><ul class="kgColList" data-bind="foreach: nonAggColumns"><li class="kgColListItem"><label style="position: relative;"><input type="checkbox" class="kgColListCheckbox" data-bind="checked: visible"> <span data-bind="text: displayName, click: toggleVisible"></span> <a title="Group By" data-bind="attr: {\'class\': groupedByClass }, visible: (field != \'\\u2714\'), click: $parent.groupBy"></a> <span class="kgGroupingNumber" data-bind="visible: groupIndex() > 0, text: groupIndex"></span></label></li></ul></div></div></div><div class="kgViewport" data-bind="css: {\'ui-widget-content\': jqueryUITheme}, style: viewportStyle"><div class="kgCanvas" data-bind="style: canvasStyle, delegatedHandler: delegatedHandler"><div data-bind="foreach: renderedRows" style="position: absolute;"><div data-bind="style: { \'top\': offsetTop, \'height\': ($data.groupHeaderHeight || $parent.rowHeight) + \'px\' }, click: toggleSelected, css: {\'selected\': selected, \'even\': isEven , \'odd\': isOdd, \'ui-state-default\': $parent.jqueryUITheme && isOdd, \'ui-state-active\':$parent.jqueryUITheme && isEven}, kgRow: $data" class="kgRow"></div></div></div></div><div class="kgFooterPanel" data-bind="if: displayFooter"><div data-bind="template: \'pagerPanelTemplate\', css: {\'ui-widget-content\': jqueryUITheme, \'ui-corner-bottom\': jqueryUITheme}, style: footerStyle"></div></div></div><script type="text/html" id="pagerPanelTemplate"><div class="kgTotalSelectContainer" data-bind="visible: pagerVisible">\n        <div class="kgPagerTotalItems" data-bind="css: {\'kgNoMultiSelect\': !multiSelect}" >\n            <span class="kgLabel">\n                <span data-bind="if: maxRowsDisplay() > 0">\n                    <span data-bind="text: recordRangeLeft"></span> - <span data-bind="text: recordRangeRight"></span> of\n                </span>\n                <span data-bind="text: maxRowsDisplay"></span> <span data-bind="text: maxRowsDisplay() == 1 ? \'record\' : \'records\'"></span>\n            </span>\n            <span data-bind="visible: showFilteredCount && filterText().length > 0" class="kgLabel">(Showing: <span data-bind="text: totalFilteredItemsLength"></span>)</span>\n        </div>\n        <div class="kgPagerSelectedItems" data-bind="visible: multiSelect() && selectedItemCount() > 0">\n            <span class="kgLabel"><span data-bind="text: selectedItemCount"></span> Selected</span>\n            <span class="kgDeselectAll" data-bind="if: deselectAllFunction">\n                <a class="kgDeselectLink" href="#" data-bind="click: deselectAllFunction">De-Select All</a>\n            </span>\n        </div>\n    </div>\n    <div class="kgPagerContainer" data-bind="visible: (pagerVisible && enablePaging), css: {\'kgNoMultiSelect\': !multiSelect}">\n        <div class="kgPagerControl">\n            <button class="kgPagerButton" data-bind="click: pageToFirst, disable: cantPageBackward()" title="First Page"><div class="kgPagerFirstTriangle"><div class="kgPagerFirstBar"></div></div></button>\n            <button class="kgPagerButton" data-bind="click: pageBackward, disable: cantPageBackward()" title="Previous Page"><div class="kgPagerFirstTriangle kgPagerPrevTriangle"></div></button>\n\n            <span data-bind="if: pagingOptions.pageSelect">\n                <select data-bind="\n                    options: pageList(),\n                    value: pagingOptions.currentPage\n                "></select>\n            </span>\n\n            <span data-bind="ifnot: pagingOptions.pageSelect">\n                <input class="kgPagerCurrent" type="number" data-bind="value: pagingOptions.currentPage, valueUpdate: \'afterkeydown\'"/>\n            </span>\n\n            <button class="kgPagerButton" data-bind="click: pageForward, disable: cantPageForward()" title="Next Page"><div class="kgPagerLastTriangle kgPagerNextTriangle"></div></button>\n            <button class="kgPagerButton" data-bind="click: pageToLast, disable: cantPageForward()" title="Last Page"><div class="kgPagerLastTriangle"><div class="kgPagerLastBar"></div></div></button>\n        </div>\n        <div class="kgRowCountPicker" data-bind="if: pagingOptions.displayPageSize">\n            <span class="kgLabel">Page Size:</span>\n            <select data-bind="value: pagingOptions.pageSize, options: pagingOptions.pageSizes"></select>\n        </div>\n    </div><\/script>'},u.kg.defaultHeaderCellTemplate=function(){return"<div data-bind=\"style: { cursor : sortable() ? 'pointer' : 'default' }, click: sort, css: {'kgSorted': !noSortVisible }, attr: {'class': 'kgHeaderSortColumn' }\"><div data-bind=\"attr: { 'class': 'colt' + $index() + ' kgHeaderText' }, html: displayName\"></div><div class=\"kgSortButtonDown\" data-bind=\"visible: showSortButtonDown\"></div><div class=\"kgSortButtonUp\" data-bind=\"visible: showSortButtonUp\"></div><div data-bind=\"visible: resizable, click: gripClick, mouseEvents: { mouseDown: gripOnMouseDown }\" class=\"kgHeaderGrip\"></div></div>"},u.kg.defaultHeaderRowTemplate=function(){return"<div data-bind=\"foreach: visibleColumns\"><div data-bind=\"kgHeaderCell: $data, attr: { 'class': 'kgHeaderCell col' + $index() + ' ' + headerClass() }\"></div></div>"},u.kg.defaultRowTemplate=function(){return"<div data-bind=\"style: { cursor : canSelectRows ? 'pointer' : 'default' }, foreach: $grid.visibleColumns, css: { 'ui-widget-content': $grid.jqueryUITheme }\"><div data-bind=\"attr: { 'class': cellClass() + ' kgCell row' + $parent.rowIndex() + ' col' + $index() }, kgCell: $data, click: onClick($parent), delegatedClick: delegatedClick($parent), delegatedDblclick: delegatedDblclick($parent)\"></div></div>"},v.bindingHandlers.kgCell={init:function(n,e,t,o,i){function r(e){var t=h(e);v.applyBindings(i,t[0]),h(n).html(t)}return i.$userViewModel=i.$parent.$userViewModel,o.cellTemplate.then?o.cellTemplate.then(function(e){r(e)}):r(o.cellTemplate),{controlsDescendantBindings:!0}}},v.bindingHandlers.kgHeaderCell={init:function(n,e,t,o,i){function r(e){var t=h(e);v.applyBindings(a,t[0]),h(n).html(t)}var a=i.extend({$grid:i.$parent,$userViewModel:i.$parent.$userViewModel});return o.headerCellTemplate.then?o.headerCellTemplate.then(function(e){r(e)}):r(o.headerCellTemplate),{controlsDescendantBindings:!0}}},v.bindingHandlers.kgHeaderRow={init:function(n,e,t,o,i){function r(e){var t=h(e);v.applyBindings(i,t[0]),h(n).html(t)}return i.$userViewModel=i.$data.$userViewModel,o.headerRowTemplate.then?o.headerRowTemplate.then(function(e){r(e)}):r(o.headerRowTemplate),{controlsDescendantBindings:!0}}},v.bindingHandlers.mouseEvents={init:function(e,t,n,o,i){var r=t();r.mouseDown&&h(e).mousedown(r.mouseDown)}},v.bindingHandlers.kgRow={init:function(n,e,t,o,i){var r,a=e(),l=a.$grid=i.$parent;function s(e){var t=h(e);a.$userViewModel=i.$parent.$userViewModel,v.applyBindings(a,t[0]),h(n).html(t)}return(r=a.isAggRow?u.kg.aggregateTemplate():l.rowTemplate).then?r.then(function(e){s(e)}):s(r),{controlsDescendantBindings:!0}}},v.bindingHandlers.koGrid={init:function(e,t,n,o,i){var r=t(),a=h(e);r.gridDim=new u.kg.Dimension({outerHeight:v.observable(a.height()),outerWidth:v.observable(a.width())});var l=new u.kg.Grid(r),s=r.gridTemplate||u.kg.defaultGridTemplate(),c=h(s);return r.data.subscribe(function(){l.$$selectionPhase||(l.searchProvider.evalFilter(),l.refreshDomSizes())}),v.isObservable(r.columnDefs)&&r.columnDefs.subscribe(function(e){l.columns([]),l.config.columnDefs=e,l.buildColumns(),l.configureColumnWidths()}),a.addClass("koGrid").addClass(l.gridId.toString()),a.append(c),l.$userViewModel=i.$data,v.applyBindings(l,c[0]),u.kg.domUtilityService.AssignGridContainers(a,l),l.configureColumnWidths(),l.refreshDomSizes(),l.eventProvider=new u.kg.EventProvider(l),h.each(l.config.plugins,function(e,t){"function"==typeof t.onGridInit&&t.onGridInit(l)}),u.kg.domUtilityService.BuildStyles(l),v.utils.domNodeDisposal.addDisposeCallback(e,function(){u.kg.domUtilityService.RemoveStyles(l)}),{controlsDescendantBindings:!0}}},u.kg.Aggregate=function(e,t){var o=this;o.index=0,o.offsetTop=v.observable(0),o.entity=e,o.label=v.observable(e.gLabel),o.field=e.gField,o.depth=e.gDepth,o.parent=e.parent,o.children=v.observableArray(e.children),o.aggChildren=e.aggChildren,o.aggIndex=e.aggIndex,o.collapsed=v.observable(t.collapseGroups),o.isAggRow=!0,o.offsetLeft=v.observable((25*e.gDepth).toString()+"px"),o.aggLabelFilter=e.aggLabelFilter,o.toggleExpand=function(){var e=o.collapsed();o.collapsed(!e),o.notifyChildren()},o.setExpand=function(e){o.collapsed(e),o.notifyChildren()},o.notifyChildren=function(){h.each(o.aggChildren,function(e,t){if(t.entity[p]=o.collapsed(),o.collapsed()){var n=o.collapsed();t.setExpand(n)}}),h.each(o.children(),function(e,t){t[p]=o.collapsed()}),t.rowCache=[],t.renderedChange()},o.aggClass=v.computed(function(){return o.collapsed()?"kgAggArrowCollapsed":"kgAggArrowExpanded"}),o.totalChildren=v.computed(function(){if(0<o.aggChildren.length){var t=0,n=function(e){0<e.aggChildren.length?h.each(e.aggChildren,function(e,t){n(t)}):t+=e.children().length};return n(o),t}return o.children().length}).extend({rateLimit:500}),o.selected=v.observable(!1),o.isEven=v.observable(!1),o.isOdd=v.observable(!1),o.toggleSelected=function(){return!0}},u.kg.Column=function(n,o){var i=this,r=n.colDef,a=0,l=null;i.eventTarget=void 0,i.width=r.width,i.groupIndex=v.observable(0),i.isGroupedBy=v.observable(!1),i.groupedByClass=v.computed(function(){return i.isGroupedBy()?"kgGroupedByIcon":"kgGroupIcon"}),i.sortable=v.observable(!1),i.resizable=v.observable(!1),i.minWidth=r.minWidth?r.minWidth:50,i.maxWidth=r.maxWidth?r.maxWidth:9e3,i.headerRowHeight=n.headerRowHeight,i.displayName=v.observable(r.displayName||r.field),i.index=n.index,i.isAggCol=n.isAggCol,i.cellClass=v.observable(r.cellClass||""),i.cellFilter=r.cellFilter||r.cellFormatter,i.field=r.field,i.aggLabelFilter=r.cellFilter||r.cellFormatter||r.aggLabelFilter||r.aggLabelFormatter,i._visible=v.observable(u.kg.utils.isNullOrUndefined(r.visible)||r.visible),i.visible=v.computed({read:function(){return i._visible()},write:function(e){i.toggleVisible(e)}}),n.enableSort&&i.sortable(u.kg.utils.isNullOrUndefined(r.sortable)||r.sortable),n.enableResize&&i.resizable(u.kg.utils.isNullOrUndefined(r.resizable)||r.resizable),i.sortDirection=v.observable(void 0),i.sortingAlgorithm=r.sortFn,i.headerClass=v.observable(r.headerClass||""),i.headerCellTemplate=r.headerCellTemplate||u.kg.defaultHeaderCellTemplate(),i.cellTemplate=r.cellTemplate||u.kg.defaultCellTemplate(),r.cellTemplate&&!c.test(r.cellTemplate)&&(i.cellTemplate=u.kg.utils.getTemplatePromise(r.cellTemplate)),r.headerCellTemplate&&!c.test(r.headerCellTemplate)&&(i.headerCellTemplate=u.kg.utils.getTemplatePromise(r.headerCellTemplate)),i.onClick=function(){return null},r.onClick&&(i.cellClass(i.cellClass()+" kgClickable"),i.onClick=function(n){return function(e,t){r.onClick(n,e,t)}}),i.delegatedClick=function(){return null},r.delegatedClick&&(i.cellClass(i.cellClass()+" kgClickable"),i.delegatedClick=function(n){return function(e,t){r.delegatedClick(n,e,t)}}),i.delegatedDblclick=function(){return null},r.delegatedDblclick&&(i.cellClass(i.cellClass()+" kgClickable"),i.delegatedDblclick=function(n){return function(e,t){r.delegatedDblclick(n,e,t)}}),i.getProperty=function(e){return i.cellFilter?i.cellFilter(e.getProperty(i.field)):e.getProperty(i.field)},i.toggleVisible=function(e){var t;t=u.kg.utils.isNullOrUndefined(e)||"object"==typeof e?!i._visible():e,i._visible(t),u.kg.domUtilityService.BuildStyles(o)},i.showSortButtonUp=v.computed(function(){return i.sortable?i.sortDirection()===t:i.sortable}),i.showSortButtonDown=v.computed(function(){return i.sortable?i.sortDirection()===s:i.sortable}),i.noSortVisible=v.computed(function(){return!i.sortDirection()}),i.sort=function(){if(!i.sortable())return!0;var e=i.sortDirection()===s?t:s;return i.sortDirection(e),n.sortCallback(i,e),!1},i.gripClick=function(e,t){t.stopPropagation(),1===++a?l=setTimeout(function(){a=0},500):(clearTimeout(l),n.resizeOnDataCallback(i),a=0)},i.gripOnMouseDown=function(e){return e.stopPropagation(),e.ctrlKey?(i.toggleVisible(),u.kg.domUtilityService.BuildStyles(o),o.config.columnsChanged(o.columns.peek()),!0):(i.eventTarget=e.target.parentElement,i.eventTarget.style.cursor="col-resize",i.startMousePosition=e.clientX,i.origWidth=i.width,h(document).mousemove(i.onMouseMove),h(document).mouseup(i.gripOnMouseUp),!1)},i.onMouseMove=function(e){e.stopPropagation();var t=e.clientX-i.startMousePosition+i.origWidth;return i.width=t<i.minWidth?i.minWidth:t>i.maxWidth?i.maxWidth:t,u.kg.domUtilityService.BuildStyles(o),!1},i.gripOnMouseUp=function(e){return e.stopPropagation(),h(document).off("mousemove"),h(document).off("mouseup"),i.eventTarget.style.cursor=i.sortable()?"pointer":"default",i.eventTarget=void 0,o.config.columnsChanged(o.columns.peek()),!1}},u.kg.Dimension=function(e){this.outerHeight=null,this.outerWidth=null,h.extend(this,e)};var n;u.kg.domUtilityService={AssignGridContainers:function(e,t){t.$root=h(e),t.$topPanel=t.$root.find(".kgTopPanel"),t.$groupPanel=t.$root.find(".kgGroupPanel"),t.$headerContainer=t.$topPanel.find(".kgHeaderContainer"),t.$headerScroller=t.$topPanel.find(".kgHeaderScroller"),t.$headers=t.$headerScroller.children(),t.$viewport=t.$root.find(".kgViewport"),t.$canvas=t.$viewport.find(".kgCanvas"),t.$footerPanel=t.$root.find(".ngFooterPanel"),u.kg.domUtilityService.UpdateGridLayout(t)},UpdateGridLayout:function(e){var t=e.$viewport.scrollTop(),n=e.$viewport.scrollLeft();e.elementDims.rootMaxW=e.$root.width(),e.elementDims.rootMaxH=e.$root.height(),e.refreshDomSizes(),e.adjustScrollTop(t,!0),e.adjustScrollLeft(n)},BuildStyles:function(e){var n,o=e.config.rowHeight,t=e.$styleSheet,i=e.gridId,r=e.visibleColumns(),a=0;t||(t=h("#"+i))[0]||(t=h("<style id='"+i+"' type='text/css' rel='stylesheet' />")).appendTo("body"),t.empty();var l=e.totalRowWidth();n=" ."+i+" .kgCanvas { width: "+l+"px; } ."+i+" .kgRow { width: "+l+"px; } ."+i+" .kgCell { height: "+o+"px; } ."+i+" .kgCanvas { width: "+l+"px; } ."+i+" .kgHeaderCell { top: 0; bottom: 0; } ."+i+" .kgHeaderScroller { width: "+(l+u.kg.domUtilityService.ScrollH+2)+"px} ",h.each(r,function(e,t){n+="."+i+" .col"+e+" { width: "+t.width+"px; left: "+a+"px; right: "+(l-a-t.width)+"px; height: "+o+"px } ."+i+" .colt"+e+" { width: "+t.width+"px; } ",a+=t.width}),u.kg.utils.isIe?t[0].styleSheet.cssText=n:t.append(document.createTextNode(n)),e.$styleSheet=t},RemoveStyles:function(e){var t=e.$styleSheet||h("#"+e.gridId);t&&t.remove()},ScrollH:17,ScrollW:17,LetterW:10},(n=h("<div></div>")).appendTo("body"),n.height(100).width(100).css("position","absolute").css("overflow","scroll"),n.append('<div style="height: 400px; width: 400px;"></div>'),u.kg.domUtilityService.ScrollH=n.height()-n[0].clientHeight,u.kg.domUtilityService.ScrollW=n.width()-n[0].clientWidth,n.empty(),n.attr("style",""),n.append('<span style="font-family: Verdana, Helvetica, Sans-Serif; font-size: 14px;"><strong>M</strong></span>'),u.kg.domUtilityService.LetterW=n.children().first().width(),n.remove(),u.kg.EventProvider=function(l){var i=this;i.colToMove=void 0,i.groupToMove=void 0,i.assignEvents=function(){l.config.jqueryUIDraggable?(l.$groupPanel.droppable({addClasses:!1,drop:function(e){i.onGroupDrop(e)}}),h(document).ready(i.setDraggables)):(l.$groupPanel.on("mousedown",i.onGroupMouseDown).on("dragover",i.dragOver).on("drop",i.onGroupDrop),l.$headerScroller.on("mousedown",i.onHeaderMouseDown).on("dragover",i.dragOver).on("drop",i.onHeaderDrop),l.config.enableRowReordering&&l.$viewport.on("mousedown",i.onRowMouseDown).on("dragover",i.dragOver).on("drop",i.onRowDrop),i.setDraggables()),l.columns.subscribe(i.setDraggables)},i.dragOver=function(e){e.preventDefault()},i.setDraggables=function(){l.config.jqueryUIDraggable?l.$root.find(".kgHeaderSortColumn").draggable({helper:"clone",appendTo:"body",stack:"div",addClasses:!1,start:function(e){i.onHeaderMouseDown(e)}}).droppable({drop:function(e){i.onHeaderDrop(e)}}):(l.$root.find(".kgHeaderSortColumn").attr("draggable","true"),-1!=navigator.userAgent.indexOf("MSIE")&&l.$root.find(".kgHeaderSortColumn").bind("selectstart",function(){return this.dragDrop(),!1}))},i.onGroupMouseDown=function(e){var t=h(e.target);if("kgRemoveGroup"!=t[0].className){var n=v.dataFor(t[0]);n&&(l.config.jqueryUIDraggable||t.attr("draggable","true"),i.groupToMove={header:t,groupName:n,index:n.groupIndex()-1})}else i.groupToMove=void 0},i.onGroupDrop=function(e){var t,n;i.groupToMove?("kgGroupPanel"==(t=h(e.target).closest(".kgGroupElement")).context.className?(l.configGroups.splice(i.groupToMove.index,1),l.configGroups.push(i.groupToMove.groupName)):(n=v.dataFor(t[0]))&&i.groupToMove.index!=n.groupIndex()&&(l.configGroups.splice(i.groupToMove.index,1),l.configGroups.splice(n.groupIndex(),0,i.groupToMove.groupName)),i.groupToMove=void 0,l.fixGroupIndexes()):(-1==l.configGroups.indexOf(i.colToMove.col)&&("kgGroupPanel"==(t=h(e.target).closest(".kgGroupElement")).context.className||"kgGroupPanelDescription"==t.context.className?l.groupBy(i.colToMove.col):(n=v.dataFor(t[0]))&&l.removeGroup(n.groupIndex())),i.colToMove=void 0)},i.onHeaderMouseDown=function(e){var t=h(e.target).closest(".kgHeaderSortColumn");if(!t[0])return!0;var n=v.dataFor(t[0]);return n&&(i.colToMove={header:t,col:n}),!0},i.onHeaderDrop=function(e){if(!i.colToMove)return!0;var t=h(e.target).closest(".kgHeaderSortColumn");if(!t[0])return!0;var n=v.dataFor(t[0]);if(n){if(i.colToMove.col==n)return!0;var o=l.columns.peek();o.splice(i.colToMove.col.index,1),o.splice(n.index,0,i.colToMove.col),l.fixColumnIndexes(),l.columns(o),u.kg.domUtilityService.BuildStyles(l),i.colToMove=void 0}return!0},i.onRowMouseDown=function(e){var t=h(e.target).closest(".kgRow");if(t[0]){var n=v.dataFor(t[0]);n&&(t.attr("draggable","true"),u.kg.eventStorage.rowToMove={targetRow:t,scope:n})}},i.onRowDrop=function(e){var t=h(e.target).closest(".kgRow"),n=v.dataFor(t[0]);if(n){var o=u.kg.eventStorage.rowToMove;if(o.scope==n)return;var i=l.sortedData(),r=i.indexOf(o.scope.entity),a=i.indexOf(n.entity);l.sortedData.splice(r,1),l.sortedData.splice(a,0,o.scope.entity),l.searchProvider.evalFilter(),u.kg.eventStorage.rowToMove=void 0}},i.assignGridEventHandlers=function(){l.$viewport.scroll(function(e){var t=e.target.scrollLeft,n=e.target.scrollTop;l.adjustScrollLeft(t),l.adjustScrollTop(n)}),l.$viewport.off("keydown"),l.config.arrowsSelectRows&&l.$viewport.on("keydown",function(e){return u.kg.moveSelectionHandler(l,e)}),-1===l.config.tabIndex?(l.$viewport.attr("tabIndex",u.kg.numberOfGrids),u.kg.numberOfGrids++):l.$viewport.attr("tabIndex",l.config.tabIndex),h(u).resize(function(){u.kg.domUtilityService.UpdateGridLayout(l),l.config.maintainColumnRatios&&l.configureColumnWidths()})},i.assignGridEventHandlers(),i.assignEvents()},u.kg.Grid=function(e){var t={rowHeight:43,columnWidth:100,headerRowHeight:30,groupHeaderHeight:43,groupIndent:!0,collapseGroups:!0,footerRowHeight:50,headerPagerHeight:50,pagerVisible:!1,displayFooter:!1,displayHeaderPager:!1,showFilteredCount:!0,canSelectRows:!0,selectAllState:v.observable(!1),data:v.observableArray([]),columnDefs:void 0,selectedItems:v.observableArray([]),displaySelectionCheckbox:!0,selectWithCheckboxOnly:!1,useExternalSorting:!1,sortInfo:v.observable(void 0),multiSelect:!0,tabIndex:-1,enableColumnResize:!0,enableSorting:!0,maintainColumnRatios:void 0,beforeSelectionChange:function(){return!0},afterSelectionChange:function(){return!0},columnsChanged:function(){},rowTemplate:void 0,headerRowTemplate:void 0,gridTemplate:void 0,jqueryUITheme:!1,jqueryUIDraggable:!1,plugins:[],keepLastSelected:!0,groups:[],showGroupPanel:!1,enableRowReordering:!1,showColumnMenu:!0,showFilter:!0,disableTextSelection:!0,arrowsSelectRows:!0,filterOptions:{filterText:v.observable(""),useExternalFilter:!1},deselectAllFunction:null,enablePaging:!1,fullHeight:!1,pagingOptions:{displayPageSize:!0,pageSelect:!1,pageSizes:v.observableArray([250,500,1e3]),pageSize:v.observable(250),totalServerItems:v.observable(0),currentPage:v.observable(1)}},g=this;g.maxCanvasHt=v.observable(0),g.config=h.extend(t,e),g.config.columnDefs=v.utils.unwrapObservable(e.columnDefs),g.gridId="ng"+u.kg.utils.newId(),g.$root=null,g.$groupPanel=null,g.$topPanel=null,g.$headerContainer=null,g.$headerScroller=null,g.$headers=null,g.$viewport=null,g.$canvas=null,g.rootDim=g.config.gridDim,g.sortInfo=v.isObservable(g.config.sortInfo)?g.config.sortInfo:v.observable(g.config.sortInfo),g.sortedData=g.config.data,g.lateBindColumns=!1,g.filteredData=v.observableArray([]),g.filteredData.extend({rateLimit:200}),g.lastSortedColumn=void 0,g.showFilter=g.config.showFilter,g.filterText=g.config.filterOptions.filterText,g.disableTextSelection=v.observable(g.config.disableTextSelection),g.delegatedHandler=g.config.delegatedHandler||[],g.calcMaxCanvasHeight=function(){return 0<g.configGroups().length?g.rowFactory.calculateHeightOfAllRows():g.filteredData().length*g.config.rowHeight},g.elementDims={scrollW:0,scrollH:0,rowIndexCellW:40,rowSelectedCellW:40,rootMaxW:0,rootMaxH:0},g.setRenderedRows=function(e){g.renderedRows(e),g.refreshDomSizes()},g.minRowsToRender=function(){var e=g.viewportDimHeight()||1,t=g.config.groupHeaderHeight?Math.min(g.config.rowHeight,g.config.groupHeaderHeight):g.config.rowHeight;return Math.floor(e/t)},g.refreshDomSizes=function(){g.rootDim.outerWidth(g.elementDims.rootMaxW),g.rootDim.outerHeight(g.elementDims.rootMaxH),g.maxCanvasHt(g.calcMaxCanvasHeight())},g.buildColumnDefsFromData=function(){var e,t=g.sortedData();(g.config.columnDefs||(g.config.columnDefs=[]),t&&t[0])?(e=t[0],u.kg.utils.forIn(e,function(e,t){t!=l&&g.config.columnDefs.push({field:t})})):g.lateBoundColumns=!0},g.buildColumns=function(){var e=g.config.columnDefs,i=[];e||(g.buildColumnDefsFromData(),e=g.config.columnDefs),g.config.displaySelectionCheckbox&&e.splice(0,0,{field:"✔",width:g.elementDims.rowSelectedCellW,sortable:!1,resizable:!1,cellClass:"checkbox-select",headerClass:"checkbox-select-header",headerCellTemplate:'<input class="kgSelectionHeader" type="checkbox" data-bind="visible: $grid.multiSelect, checked: $grid.allSelected"/>',cellTemplate:'<div class="kgSelectionCell"><input class="kgSelectionCheckbox" type="checkbox" data-bind="checked: $parent.selected" /></div>'}),0<e.length&&(h.each(e,function(e,t){var n=new u.kg.Column({colDef:t,index:e,headerRowHeight:g.config.headerRowHeight,sortCallback:g.sortData,resizeOnDataCallback:g.resizeOnData,enableResize:g.config.enableColumnResize,enableSort:g.config.enableSorting},g);i.push(n);var o=g.config.groups.indexOf(t.field);-1!=o&&g.configGroups.splice(o,0,n)}),g.columns(i),h.each(g.config.groups,function(e,t){if(!v.utils.arrayFirst(g.configGroups(),function(e){return e.field==t})){var n=new u.kg.Column({colDef:{field:t},index:g.columns().length+e,headerRowHeight:g.config.headerRowHeight,sortCallback:g.sortData,resizeOnDataCallback:g.resizeOnData,enableResize:g.config.enableColumnResize,enableSort:g.config.enableSorting},g);g.configGroups.push(n)}}))},g.configureColumnWidths=function(){var e=g.config.columnDefs,i=e.length,r=[],a=[],l=0,s=0,c=g.columns();if(h.each(e,function(e,t){var n,o=!1;if(u.kg.utils.isNullOrUndefined(t.width)?t.width="*":n=(o=!!isNaN(t.width)&&u.kg.utils.endsWith(t.width,"%"))?t.width:parseInt(t.width,10),isNaN(n))if("auto"==(n=t.width)){c[e].width=c[e].minWidth;var i=c[e];h(document).ready(function(){g.resizeOnData(i,!0)})}else if(-1!=n.indexOf("*"))l+=n.length,t.index=e,r.push(t);else{if(!o)throw'unable to parse column width, use percentage ("10%","20%", etc...) or "*" to use remaining width of grid';t.index=e,a.push(t)}else s+=c[e].width=parseInt(t.width,10)}),0<r.length){!1===g.config.maintainColumnRatios?h.noop():g.config.maintainColumnRatios=!0;var t=g.rootDim.outerWidth()-s,d=Math.floor(t/l);h.each(r,function(e,t){var n=t.width.length;if(c[t.index].width=d*n,t.index+1==i){var o=2;g.maxCanvasHt()>g.viewportDimHeight()&&(o+=u.kg.domUtilityService.ScrollW),c[t.index].width-=o}s+=c[t.index].width})}0<a.length&&h.each(a,function(e,t){var n=t.width;c[t.index].width=Math.floor(g.rootDim.outerWidth()*(parseInt(n.slice(0,-1),10)/100))}),g.columns(c),u.kg.domUtilityService.BuildStyles(g)},g.init=function(){g.selectionService=new u.kg.SelectionService(g),g.rowFactory=new u.kg.RowFactory(g),g.fullHeight&&g.filteredData.subscribe(function(e){setTimeout(function(){h(u).resize()},100)}),g.selectionService.Initialize(g.rowFactory),g.buildColumns(),g.searchProvider=new u.kg.SearchProvider(g),g.styleProvider=new u.kg.StyleProvider(g),u.kg.sortService.columns=g.columns,g.configGroups.subscribe(function(e){if(e){var n=[];h.each(e,function(e,t){t&&n.push(t.field||t)}),g.config.groups=n,g.rowFactory.filteredDataChanged()}}),g.filteredData.subscribe(function(){g.$$selectionPhase||(g.maxCanvasHt(g.calcMaxCanvasHeight()),g.isSorting||g.configureColumnWidths())}),g.maxCanvasHt(g.calcMaxCanvasHeight()),g.searchProvider.evalFilter(),g.refreshDomSizes()},g.prevScrollTop=0,g.prevScrollIndex=0,g.adjustScrollTop=function(e,t){if(g.prevScrollTop!==e||t){var n=Math.floor(e/g.config.rowHeight);g.prevScrollTop<e&&n<g.prevScrollIndex+6||g.prevScrollTop>e&&n>g.prevScrollIndex-6||(g.prevScrollTop=e,g.rowFactory.UpdateViewableRange(new u.kg.Range(Math.max(0,n-8),n+g.minRowsToRender()+8)),g.prevScrollIndex=n)}},g.adjustScrollLeft=function(e){g.$headerContainer&&g.$headerContainer.scrollLeft(e)},g.resizeOnData=function(e){var r=e.minWidth,t=u.kg.utils.getElementsByClassName("col"+e.index);h.each(t,function(e,t){var n;if(0===e){var o=h(t).find(".kgHeaderText");n=u.kg.utils.visualLength(o)+10}else{var i=h(t).find(".kgCellText");n=u.kg.utils.visualLength(i)+10}r<n&&(r=n)}),e.width=r=Math.min(e.maxWidth,r+7),u.kg.domUtilityService.BuildStyles(g)},g.sortData=function(e,t){g.isSorting=!0,g.sortInfo({column:e,direction:t}),g.clearSortingData(e),g.config.useExternalSorting?g.config.sortInfo(g.sortInfo.peek()):u.kg.sortService.Sort(g.sortInfo.peek(),g.sortedData),g.lastSortedColumn=e,g.isSorting=!1},g.clearSortingData=function(e){e?g.lastSortedColumn&&e!=g.lastSortedColumn&&g.lastSortedColumn.sortDirection(""):h.each(g.columns(),function(e,t){t.sortDirection("")})},g.fixColumnIndexes=function(){g.$$indexPhase=!0;var e=g.columns.peek();h.each(e,function(e,t){t.index=e}),g.$$indexPhase=!1},g.elementsNeedMeasuring=!0,g.columns=v.observableArray([]),g.columns.subscribe(function(e){g.config.columnsChanged(e)}),g.renderedRows=v.observableArray([]),g.headerRow=null,g.rowHeight=g.config.rowHeight,g.jqueryUITheme=v.observable(g.config.jqueryUITheme),g.footer=null,g.selectedItems=g.config.selectedItems,g.pagerVisible=g.config.pagerVisible,g.displayFooter=g.config.displayFooter,g.displayHeaderPager=g.config.displayHeaderPager,g.showFilteredCount=g.config.showFilteredCount,g.config.footerRowHeight=g.pagerVisible?g.config.footerRowHeight:0,g.config.headerPagerHeight=g.displayHeaderPager?g.config.headerPagerHeight:0,g.showColumnMenu=g.config.showColumnMenu,g.showMenu=v.observable(!1),g.configGroups=v.observableArray([]),g.deselectAllFunction=g.config.deselectAllFunction,g.enablePaging=g.config.enablePaging,g.pagingOptions=g.config.pagingOptions,g.fullHeight=g.config.enablePaging&&g.config.fullHeight,g.rowTemplate=g.config.rowTemplate||u.kg.defaultRowTemplate(),g.headerRowTemplate=g.config.headerRowTemplate||u.kg.defaultHeaderRowTemplate(),g.gridTemplate=g.config.gridTemplate||u.kg.defaultGridTemplate(),g.config.rowTemplate&&!c.test(g.config.rowTemplate)&&(g.rowTemplate=u.kg.utils.getTemplatePromise(g.config.rowTemplate)),g.config.headerRowTemplate&&!c.test(g.config.headerRowTemplate)&&(g.headerRowTemplate=u.kg.utils.getTemplatePromise(g.config.headerRowTemplate)),g.config.gridTemplate&&!c.test(g.config.gridTemplate)&&(g.gridTemplate=u.kg.utils.getTemplatePromise(g.config.gridTemplate)),g.visibleColumns=v.computed(function(){return g.columns().filter(function(e){return e.visible()})}),g.nonAggColumns=v.computed(function(){return g.columns().filter(function(e){return!e.isAggCol})}),g.toggleShowMenu=function(){g.showMenu(!g.showMenu())},g.allSelected=g.config.selectAllState,g.allSelected.subscribe(function(e){g.config.beforeSelectionChange(g.sortedData.peek(),this)&&(g.selectionService.toggleSelectAll(e),g.config.afterSelectionChange(g.selectedItems.peek(),this))}),g.totalFilteredItemsLength=v.computed(function(){return g.filteredData().length}),g.showGroupPanel=v.computed(function(){return g.config.showGroupPanel}),g.topPanelHeight=v.observable(!0===g.config.showGroupPanel?2*(g.config.headerRowHeight+g.config.headerPagerHeight):g.config.headerRowHeight+g.config.headerPagerHeight),g.viewportDimHeight=v.computed(function(){return g.fullHeight?g.maxCanvasHt():Math.max(0,g.rootDim.outerHeight()-g.topPanelHeight()-g.config.footerRowHeight-2)}),g.groupBy=function(e){if(!(g.sortedData().length<1)){var t=g.configGroups().indexOf(e);-1==t?(e.isGroupedBy(!0),g.configGroups.push(e),e.groupIndex(g.configGroups().length)):g.removeGroup(t),u.kg.domUtilityService.BuildStyles(g)}},g.removeGroup=function(t){var e=g.columns().filter(function(e){return e.groupIndex()==t+1})[0];e.isGroupedBy(!1),e.groupIndex(0),g.columns.splice(t,1),g.configGroups.splice(t,1),g.fixGroupIndexes(),0===g.configGroups().length&&g.fixColumnIndexes(),u.kg.domUtilityService.BuildStyles(g)},g.fixGroupIndexes=function(){h.each(g.configGroups(),function(e,t){t.groupIndex(e+1)})},g.totalRowWidth=function(){var n=0,e=g.visibleColumns();return h.each(e,function(e,t){n+=t.width}),n},g.headerScrollerDim=function(){var e=g.viewportDimHeight(),t=g.maxCanvasHt(),n=e<t,o=new u.kg.Dimension;return o.autoFitHeight=!0,o.outerWidth=g.totalRowWidth(),n?o.outerWidth+=g.elementDims.scrollW:t-e<=g.elementDims.scrollH&&(o.outerWidth+=g.elementDims.scrollW),o},g.jqueryUITheme=g.config.jqueryUITheme,g.maxRows=v.observable(g.config.pagingOptions.totalServerItems()||g.sortedData().length),g.maxRowsDisplay=v.computed(function(){return g.maxRows()}),g.multiSelect=v.observable(g.config.displaySelectionCheckbox&&g.config.multiSelect),g.selectedItemCount=v.computed(function(){return g.selectedItems().length}),g.maxPages=v.computed(function(){return g.maxRows(g.config.pagingOptions.totalServerItems()||g.sortedData().length),Math.ceil((g.maxRows()||1)/g.pagingOptions.pageSize())}),g.recordRangeLeft=v.computed(function(){return(g.pagingOptions.currentPage()-1)*g.pagingOptions.pageSize()||1}),g.recordRangeRight=v.computed(function(){return Math.min(g.pagingOptions.currentPage()*g.pagingOptions.pageSize(),g.pagingOptions.totalServerItems())}),g.pageForward=function(){var e=g.config.pagingOptions.currentPage();g.config.pagingOptions.currentPage(Math.min(e+1,g.maxPages()))},g.pageBackward=function(){var e=g.config.pagingOptions.currentPage();g.config.pagingOptions.currentPage(Math.max(e-1,1))},g.pageToFirst=function(){g.config.pagingOptions.currentPage(1)},g.pageToLast=function(){var e=g.maxPages();g.config.pagingOptions.currentPage(e)},g.cantPageForward=v.computed(function(){return!(g.config.pagingOptions.currentPage()<g.maxPages())}),g.cantPageBackward=v.computed(function(){return!(1<g.config.pagingOptions.currentPage())}),g.enablePaging&&g.pagingOptions.pageSelect&&(g.pageList=v.computed(function(){for(var e=g.maxPages()||1,t=[],n=1;n<=e;n++)t.push(n);return t})),g.init()},u.kg.Range=function(e,t){this.topRow=e,this.bottomRow=t},u.kg.Row=function(e,o,t){var i=this;i.canSelectRows=o.canSelectRows,i.rowClasses=o.rowClasses,i.selectedItems=o.selectedItems,i.entity=e,i.selectionService=t,i.selected=v.observable(!1),i.continueSelection=function(e){i.selectionService.ChangeSelection(i,e)},i.canSelect=function(e){var t=e.target||e;return i.canSelectRows||h(t).hasClass("checkbox-select")||h(t).hasClass("kgSelectionCell")||h(t).hasClass("kgSelectionCheckbox")},i.toggleSelected=function(e,t){if(!i.canSelect(t))return!0;var n=t.target||t;return"checkbox"==n.type&&i.selected(!i.selected()),!(!o.selectWithCheckboxOnly||"checkbox"==n.type)||!!i.beforeSelectionChange(i,t)&&(i.continueSelection(t),i.afterSelectionChange(i,t))},void 0===i.entity[l]?i.entity[l]=!1:i.selectionService.setSelection(i,i.entity[l]),i.rowIndex=v.observable(0),i.offsetTop=v.observable("0px"),i.rowDisplayIndex=0,i.isEven=v.computed(function(){return i.rowIndex()%2==0}),i.isOdd=v.computed(function(){return i.rowIndex()%2!=0}),i.beforeSelectionChange=o.beforeSelectionChangeCallback,i.afterSelectionChange=o.afterSelectionChangeCallback,i.propertyCache={},i.getProperty=function(e){return i.propertyCache[e]||(i.propertyCache[e]=u.kg.utils.evalProperty(i.entity,e))}},u.kg.RowFactory=function(s){var c=this;c.rowCache=[],c.aggCache=[],c.parentCache=[],c.dataChanged=!0,c.parsedData=[],c.rowConfig={},c.selectionService=s.selectionService,c.numberOfAggregates=0,c.groupedData=void 0,c.rowHeight=s.config.rowHeight,c.groupHeaderHeight=s.config.groupHeaderHeight,c.groupIndent=s.config.groupIndent,c.collapseGroups=s.config.collapseGroups,c.rowConfig={canSelectRows:s.config.canSelectRows,rowClasses:s.config.rowClasses,selectedItems:s.config.selectedItems,selectWithCheckboxOnly:s.config.selectWithCheckboxOnly,beforeSelectionChangeCallback:s.config.beforeSelectionChange,afterSelectionChangeCallback:s.config.afterSelectionChange},c.renderedRange=new u.kg.Range(0,s.minRowsToRender()+8),c.calculateAggRowOffsetTop=function(e,t){return(e-t)*c.rowHeight+t*c.groupHeaderHeight},c.buildEntityRow=function(e,t){var n=c.rowCache[t];if(!n){(n=new u.kg.Row(e,c.rowConfig,c.selectionService)).rowIndex(t+1);var o=void 0===e[i]?c.rowHeight*t:c.calculateAggRowOffsetTop(t,e[i]+1);n.offsetTop(o.toString()+"px"),n.selected(e[l]),c.rowCache[t]=n}return n},c.buildAggregateRow=function(e,t){var n=c.aggCache[e.aggIndex];return n||(n=new u.kg.Aggregate(e,c),c.aggCache[e.aggIndex]=n),n.index=t+1,n.offsetTop(c.calculateAggRowOffsetTop(t,e.aggIndex).toString()+"px"),n},c.UpdateViewableRange=function(e){c.renderedRange=e,c.renderedChange()},c.filteredDataChanged=function(){s.lateBoundColumns&&1<s.filteredData().length&&(s.config.columnDefs=void 0,s.buildColumns(),s.lateBoundColumns=!1),c.dataChanged=!0,c.rowCache=[],0<s.config.groups.length&&c.getGrouping(s.config.groups),c.UpdateViewableRange(c.renderedRange)},c.renderedChange=function(){if(!c.groupedData||s.config.groups.length<1)return c.renderedChangeNoGroups(),void s.refreshDomSizes();c.parentCache=[];var o=[],e=c.parsedData.filter(function(e){return!1===e[p]}).slice(c.renderedRange.topRow,c.renderedRange.bottomRow);h.each(e,function(e,t){var n;n=t.isAggRow?c.buildAggregateRow(t,c.renderedRange.topRow+e):c.buildEntityRow(t,c.renderedRange.topRow+e),o.push(n)}),s.setRenderedRows(o)},c.renderedChangeNoGroups=function(){var o=[],e=s.filteredData.slice(c.renderedRange.topRow,c.renderedRange.bottomRow);h.each(e,function(e,t){var n=c.buildEntityRow(t,c.renderedRange.topRow+e);o.push(n)}),s.setRenderedRows(o)},c.parseGroupData=function(e){if(e.values)h.each(e.values,function(e,t){c.parentCache[c.parentCache.length-1].children.push(t),t[i]=c.numberOfAggregates-1,c.parsedData.push(t)});else for(var t in e)if(t!=d&&t!=g&&t!=f&&e.hasOwnProperty(t)){var n={gField:e[d],gLabel:t,gDepth:e[g],isAggRow:!0,children:[],aggChildren:[],aggIndex:c.numberOfAggregates,aggLabelFilter:e[f].aggLabelFilter,_kg_hidden_:!1},o=c.buildAggregateRow(n,0);c.numberOfAggregates++,o.parent=c.parentCache[o.depth-1],o.groupHeaderHeight=c.groupHeaderHeight,o.parent&&(o.parent.collapsed(!1),o.parent.aggChildren.push(o)),c.parsedData.push(o.entity),c.parentCache[o.depth]=o,c.parseGroupData(e[t])}},c.getGrouping=function(t){c.aggCache=[],c.rowCache=[],c.numberOfAggregates=0,c.groupedData={};var e=s.filteredData(),a=t.length,l=s.columns();h.each(e,function(e,i){i[p]=c.collapseGroups;var r=c.groupedData;h.each(t,function(e,t){c.groupIndent&&!l[e].isAggCol&&e<=a&&(s.columns.splice(i.gDepth,0,new u.kg.Column({colDef:{field:"",width:25,sortable:!1,resizable:!1,headerCellTemplate:'<div class="kgAggHeader"></div>'},isAggCol:!0,index:i.gDepth,headerRowHeight:s.config.headerRowHeight})),u.kg.domUtilityService.BuildStyles(s));var n=u.kg.utils.evalProperty(i,t),o=l.filter(function(e){return e.field==t})[0];o&&o.cellFilter&&(n=o.cellFilter(n)),n=n?n.toString():"null",r[n]||(r[n]={}),r[d]||(r[d]=t),r[g]||(r[g]=e),r[f]||(r[f]=o||{}),r=r[n]}),r.values||(r.values=[]),r.values.push(i)}),s.fixColumnIndexes(),c.parsedData.length=0,c.parseGroupData(c.groupedData)},c.calculateHeightOfAllRows=function(){return c.parsedData.filter(function(e){return!0!==e.isAggRow&&!1===e[p]}).length*c.rowHeight+c.numberOfAggregates*c.groupHeaderHeight},0<s.config.groups.length&&0<s.filteredData().length&&c.getGrouping(s.config.groups)},u.kg.SearchProvider=function(e){var t,s=this,c=[];s.extFilter=e.config.filterOptions.useExternalFilter,s.showFilter=e.config.showFilter,s.filterText=e.config.filterOptions.filterText,s.throttle=e.config.filterOptions.filterThrottle,s.fieldMap={},s.evalFilter=function(){0===c.length?e.filteredData(e.sortedData.peek().filter(function(e){return!e._destroy})):e.filteredData(e.sortedData.peek().filter(function(e){if(e._destroy)return!1;for(var t=!1,n=0,o=c.length;n<o;n++){var i=c[n];if(i.column){var r=v.utils.unwrapObservable(e[i.column])||v.utils.unwrapObservable(e[s.fieldMap[i.columnDisplay]]);if(r&&i.regex.test(r.toString()))t=!0;else if(i.required)return!1}else for(var a in e)if(e.hasOwnProperty(a)){var l=v.utils.unwrapObservable(e[a]);if(l&&i.regex.test(l.toString()))return!0}}return t})),e.rowFactory.filteredDataChanged()};function l(t,e){try{return new RegExp(t,e)}catch(e){return new RegExp(t.replace(/(\^|\$|\(|\)|\[|\]|\{|\}|\\|\||\.|\*|\+|\?)/g,"\\$1"))}}var n=v.computed(function(){var e=s.filterText();s.extFilter||e==t||(function(e){var t;if(c=[],t=h.trim(e)){var n=t.split(";");h.each(n,function(e,t){var n=t.split(":");if(1<n.length){var o=h.trim(n[0]),i=h.trim(n[1]),r=!0;"?"===o[o.length-1]&&(r=!1,o=o.replace("?","")),o&&i&&c.push({column:o,columnDisplay:o.replace(/\s+/g,"").toLowerCase(),regex:l(i,"i"),required:r})}else{var a=h.trim(n[0]);a&&c.push({column:null,regex:l(a,"i"),required:!1})}})}}(t=e),s.evalFilter())});"number"==typeof s.throttle&&n.extend({throttle:s.throttle}),s.extFilter||e.columns.subscribe(function(e){h.each(e,function(e,t){s.fieldMap[t.displayName().toLowerCase().replace(/\s+/g,"")]=t.field})})},u.kg.SelectionService=function(r){var a=this;a.multi=r.config.multiSelect,a.selectedItems=r.config.selectedItems,a.selectedIndex=r.config.selectedIndex,a.lastClickedRow=void 0,a.ignoreSelectedItemChanges=!1,a.rowFactory={},a.Initialize=function(e){a.rowFactory=e},a.ChangeSelection=function(e,t){if(r.$$selectionPhase=!0,t&&t.shiftKey&&a.multi){if(a.lastClickedRow){var n=r.filteredData.indexOf(e.entity),o=r.filteredData.indexOf(a.lastClickedRow.entity);if(n==o)return r.$$selectionPhase=!1;n<++o&&(n^=o,n^=o^=n);for(var i=[];o<=n;o++)i.push(a.rowFactory.rowCache[o]);i[i.length-1].beforeSelectionChange(i,t)&&(h.each(i,function(e,t){t.selected(!0),t.entity[l]=!0,-1===a.selectedItems.indexOf(t.entity)&&a.selectedItems.push(t.entity)}),i[i.length-1].afterSelectionChange(i,t))}}else a.multi?a.setSelection(e,!e.selected()):(a.lastClickedRow&&a.lastClickedRow!=e&&a.setSelection(a.lastClickedRow,!1),a.setSelection(e,!!r.config.keepLastSelected||!e.selected()));return a.lastClickedRow=e,!(r.$$selectionPhase=!1)},a.setSelection=function(e,t){e.selected(t),(e.entity[l]=t)?-1===a.selectedItems.indexOf(e.entity)&&a.selectedItems.push(e.entity):a.selectedItems.remove(e.entity)},a.toggleSelectAll=function(n){var e=a.selectedItems().length;0<e&&a.selectedItems.splice(0,e),h.each(r.filteredData(),function(e,t){(t[l]=n)&&a.selectedItems.push(t)}),h.each(a.rowFactory.rowCache,function(e,t){t&&t.selected&&t.selected(n)})}},u.kg.sortService={colSortFnCache:{},dateRE:/^(\d\d?)[\/\.-](\d\d?)[\/\.-]((\d\d)?\d\d)$/,guessSortFn:function(e){var t,n,o,i;if(null==e||""===e)return null;switch(n=typeof e){case"number":t=u.kg.sortService.sortNumber;break;case"boolean":t=u.kg.sortService.sortBool;break;default:t=void 0}return t||("[object Date]"===Object.prototype.toString.call(e)?u.kg.sortService.sortDate:"string"!=n?u.kg.sortService.basicSort:e.match(/^-?[£$¤]?[\d,.]+%?$/)?u.kg.sortService.sortNumberStr:(o=e.match(u.kg.sortService.dateRE))?(i=parseInt(o[1],10),parseInt(o[2],10),12<i?u.kg.sortService.sortDDMMStr:u.kg.sortService.sortMMDDStr):u.kg.sortService.sortAlpha)},basicSort:function(e,t){return e==t?0:e<t?-1:1},sortNumber:function(e,t){return e-t},sortNumberStr:function(e,t){var n,o,i=!1,r=!1;return n=parseFloat(e.replace(/[^0-9.-]/g,"")),isNaN(n)&&(i=!0),o=parseFloat(t.replace(/[^0-9.-]/g,"")),isNaN(o)&&(r=!0),i&&r?0:i?1:r?-1:n-o},sortAlpha:function(e,t){var n=e.toLowerCase(),o=t.toLowerCase();return n==o?0:n<o?-1:1},sortBool:function(e,t){return e&&t?0:e||t?e?1:-1:0},sortDate:function(e,t){var n=e.getTime(),o=t.getTime();return n==o?0:n<o?-1:1},sortDDMMStr:function(e,t){var n,o,i,r,a,l;return l=(i=e.match(u.kg.sortService.dateRE))[3],r=i[2],a=i[1],1==r.length&&(r="0"+r),1==a.length&&(a="0"+a),n=l+r+a,l=(i=t.match(u.kg.sortService.dateRE))[3],r=i[2],a=i[1],1==r.length&&(r="0"+r),1==a.length&&(a="0"+a),n==(o=l+r+a)?0:n<o?-1:1},sortMMDDStr:function(e,t){var n,o,i,r,a,l;return l=(i=e.match(u.kg.sortService.dateRE))[3],a=i[2],1==(r=i[1]).length&&(r="0"+r),1==a.length&&(a="0"+a),n=l+r+a,l=(i=t.match(u.kg.sortService.dateRE))[3],a=i[2],1==(r=i[1]).length&&(r="0"+r),1==a.length&&(a="0"+a),n==(o=l+r+a)?0:n<o?-1:1},sortData:function(e,t){var n=e();if(n&&t){var i,o,r=t.column,a=t.direction;if(u.kg.sortService.colSortFnCache[r.field])i=u.kg.sortService.colSortFnCache[r.field];else if(null!=r.sortingAlgorithm)i=r.sortingAlgorithm,u.kg.sortService.colSortFnCache[r.field]=r.sortingAlgorithm;else{if(!(o=n[0]))return;(i=u.kg.sortService.guessSortFn(o[r.field]))?u.kg.sortService.colSortFnCache[r.field]=i:i=u.kg.sortService.sortAlpha}n.sort(function(e,t){var n=u.kg.utils.evalProperty(e,r.field),o=u.kg.utils.evalProperty(t,r.field);return o||n?n?o?a===s?i(n,o):0-i(n,o):-1:1:0}),e(n)}},Sort:function(e,t){u.kg.sortService.isSorting||(u.kg.sortService.isSorting=!0,u.kg.sortService.sortData(t,e),u.kg.sortService.isSorting=!1)}},u.kg.StyleProvider=function(e){e.canvasStyle=v.computed(function(){return{height:e.maxCanvasHt().toString()+"px"}}),e.headerScrollerStyle=v.computed(function(){return{height:e.config.headerRowHeight+"px"}}),e.topPanelStyle=v.computed(function(){return{width:e.rootDim.outerWidth()+"px",height:e.topPanelHeight()+"px"}}),e.headerStyle=v.computed(function(){return{width:(e.fullHeight?e.rootDim.outerWidth():Math.max(0,e.rootDim.outerWidth()-u.kg.domUtilityService.ScrollW))+"px",height:e.config.headerRowHeight+"px"}}),e.headerPagerStyle=v.computed(function(){return{width:(e.fullHeight?e.rootDim.outerWidth():Math.max(0,e.rootDim.outerWidth()-u.kg.domUtilityService.ScrollW))+"px",height:e.config.headerPagerHeight+"px"}}),e.viewportStyle=v.computed(function(){return{width:e.rootDim.outerWidth()+"px",height:e.viewportDimHeight()+"px"}}),e.footerStyle=v.computed(function(){return{width:e.rootDim.outerWidth()+"px",height:e.config.footerRowHeight+"px"}})}}(window)});